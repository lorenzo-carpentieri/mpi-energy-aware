# Running Experiments on Leonardo

This guide explains how to compile, run, parse, and plot energy measurements for MPI collectives using NCCL on Leonardo.

---

## 1. Set Up Environment

From the `mpi-energy-aware` directory, load the NCCL environment:

```bash
source scripts/leonardo/env/set_nccl_env.sh
```

---

## 2. Compile MPI Collective Code

Compile the CUDA-based MPI collective code:

```bash
make -C cuda/
```

---

## 3. Run Experiments

Run a specific MPI collective with all parameter configurations (threads, algorithm, channels, protocol):

```bash
python3 scripts/run-sbatch/run_all_param.py \
    --sbatch-script-file=$(pwd)/scripts/leonardo/sbatch/nccl/nccl_a2a_tuning.sh \
    --log-dir=$(pwd)/logs/ \
    --coll="a2a"
```

### Script Parameters

- `--sbatch-script-file` — SBATCH script used for running the collective.  
- `--log-dir` — Directory where all results are stored.  
- `--coll` — Collective to execute (`a2a` or `ar`).  

---

## 4. Parse Log Files

Parse the raw log files to extract host/device energy and timing:

```bash
python3 scripts/leonardo/nccl/parse-log-file/parse_host_device_energy.py \
    --log-dir=$(pwd)/logs/perf/nccl/ar/ \
    --out-dir=$(pwd)/data/ \
    --app=ar
```

### Script Parameters

- `--log-dir` — Directory containing raw files generated by `run_all_param.py`.  
- `--out-dir` — Directory where parsed results will be stored.  
- `--app` — Specify the collective (`a2a` or `ar`).  

The script generates a CSV file containing energy and time information for the specified collective.

---

## 5. Generate Plots

Generate plots for all collectives:

```bash
python3 scripts/leonardo/plots/nccl/nccl_all_params.py \
    --csv-file=$(pwd)/data/nccl_ar_all_params.csv \
    --out-dir=$(pwd)/data/plots/
```

### Script Parameters

- `--csv-file` — CSV file containing time and energy data for one or more collectives.  
- `--out-dir` — Directory where plots will be saved.  

The plot directory contains a folder for each collective. Each collective folder includes:

- `device/` — Data for device energy only.  
- `host/` — Data for host energy only.  
- `host_device/` — Combined host + device energy data.  

---

## 6. Example Workflow

For a full workflow using the `ar` collective:

```bash
# Set up environment
source scripts/leonardo/env/set_nccl_env.sh

# Compile code
make -C cuda/

# Run experiments
python3 scripts/run-sbatch/run_all_param.py \
    --sbatch-script-file=$(pwd)/scripts/leonardo/sbatch/nccl/nccl_ar_tuning.sh \
    --log-dir=$(pwd)/logs/ \
    --coll="ar"

# Parse results
python3 scripts/leonardo/nccl/parse-log-file/parse_host_device_energy.py \
    --log-dir=$(pwd)/logs/perf/nccl/ar/ \
    --out-dir=$(pwd)/data/ \
    --app=ar

# Generate plots
python3 scripts/leonardo/plots/nccl/nccl_all_params.py \
    --csv-file=$(pwd)/data/nccl_ar_all_params.csv \
    --out-dir=$(pwd)/data/plots/
```

This sequence ensures all results are compiled, executed, parsed, and visualized.

